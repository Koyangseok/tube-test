<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>YouTube Player</title>
  <style>
    html, body { margin:0; padding:0; width:100%; height:100%; background:#000; overflow:hidden; }
    #playerWrap { width:100%; height:100%; }
    .error {
      position:fixed; inset:0;
      padding:16px;
      font-family:Arial, system-ui, -apple-system, Segoe UI, Roboto;
      font-size:14px; line-height:1.6;
      color:#9bd0ff; background:#000;
    }
    a{ color:#9bd0ff; }
    .toast {
      position: fixed;
      left: 50%;
      bottom: 16px;
      transform: translateX(-50%);
      background: rgba(0,0,0,.72);
      color: #fff;
      padding: 10px 12px;
      border-radius: 10px;
      font-family: Arial, system-ui, -apple-system, Segoe UI, Roboto;
      font-size: 13px;
      display:none;
      z-index: 9999;
      user-select:none;
      white-space: nowrap;
    }

    /* ============================
       ë¹„ë°€ë²ˆí˜¸ ì˜¤ë²„ë ˆì´
    ============================ */
    #pwOverlay {
      position: fixed;
      inset: 0;
      background: #000;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      font-family: 'Segoe UI', Arial, system-ui, sans-serif;
    }
    #pwBox {
      background: #111;
      border: 1px solid #333;
      border-radius: 14px;
      padding: 36px 32px 28px;
      width: 320px;
      max-width: 90vw;
      text-align: center;
      box-shadow: 0 8px 40px rgba(0,0,0,.8);
    }
    #pwBox .lock-icon {
      font-size: 40px;
      margin-bottom: 14px;
    }
    #pwBox h2 {
      margin: 0 0 6px;
      font-size: 18px;
      color: #fff;
      font-weight: 600;
    }
    #pwBox p {
      margin: 0 0 22px;
      font-size: 13px;
      color: #777;
    }
    #pwInput {
      width: 100%;
      box-sizing: border-box;
      background: #1a1a1a;
      border: 1px solid #444;
      border-radius: 8px;
      color: #fff;
      font-size: 16px;
      padding: 11px 14px;
      outline: none;
      transition: border-color .2s;
      letter-spacing: 2px;
    }
    #pwInput:focus {
      border-color: #9bd0ff;
    }
    #pwInput.shake {
      animation: shake .35s ease;
      border-color: #ff5555 !important;
    }
    @keyframes shake {
      0%,100%{ transform:translateX(0) }
      20%    { transform:translateX(-8px) }
      40%    { transform:translateX(8px) }
      60%    { transform:translateX(-6px) }
      80%    { transform:translateX(5px) }
    }
    #pwBtn {
      margin-top: 14px;
      width: 100%;
      background: #9bd0ff;
      color: #000;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 700;
      padding: 11px;
      cursor: pointer;
      transition: background .15s, transform .1s;
    }
    #pwBtn:hover { background: #b8dbff; }
    #pwBtn:active { transform: scale(.97); }
    #pwErr {
      margin-top: 10px;
      font-size: 13px;
      color: #ff5555;
      min-height: 18px;
    }
  </style>
</head>
<body>

  <!-- ë¹„ë°€ë²ˆí˜¸ ì˜¤ë²„ë ˆì´ -->
  <div id="pwOverlay">
    <div id="pwBox">
      <div class="lock-icon">ğŸ”’</div>
      <h2>ë¹„ë°€ë²ˆí˜¸ ì…ë ¥</h2>
      <p>ì˜ìƒì„ ì¬ìƒí•˜ë ¤ë©´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
      <input type="password" id="pwInput" placeholder="ë¹„ë°€ë²ˆí˜¸" autocomplete="current-password" />
      <button id="pwBtn">í™•ì¸</button>
      <div id="pwErr"></div>
    </div>
  </div>

  <div id="playerWrap"></div>
  <div class="error" id="err" style="display:none;"></div>
  <div class="toast" id="toast"></div>

<script>
(() => {
  "use strict";

  // =========================
  // âœ… ë¹„ë°€ë²ˆí˜¸ ì„¤ì • (ì—¬ê¸°ì„œ ë³€ê²½í•˜ì„¸ìš”)
  // =========================
  const CORRECT_PASSWORD = "1234";          // â† ì›í•˜ëŠ” ë¹„ë°€ë²ˆí˜¸ë¡œ ë³€ê²½
  const PW_STORAGE_KEY   = "GYS_PW_AUTH";  // localStorage í‚¤
  const PW_EXPIRE_MS     = 30 * 24 * 60 * 60 * 1000; // 30ì¼

  // =========================
  // ì¸ì¦ í™•ì¸ & UI ì²˜ë¦¬
  // =========================
  const pwOverlay = document.getElementById("pwOverlay");
  const pwInput   = document.getElementById("pwInput");
  const pwBtn     = document.getElementById("pwBtn");
  const pwErr     = document.getElementById("pwErr");

  function isAuthenticated() {
    try {
      const raw = localStorage.getItem(PW_STORAGE_KEY);
      if (!raw) return false;
      const obj = JSON.parse(raw);
      if (!obj?.ok) return false;
      if (Date.now() - Number(obj.ts ?? 0) > PW_EXPIRE_MS) {
        localStorage.removeItem(PW_STORAGE_KEY);
        return false;
      }
      return true;
    } catch { return false; }
  }

  function saveAuth() {
    try {
      localStorage.setItem(PW_STORAGE_KEY, JSON.stringify({ ok: true, ts: Date.now() }));
    } catch {}
  }

  function handlePwSubmit() {
    const val = pwInput.value;
    if (val === CORRECT_PASSWORD) {
      saveAuth();
      pwOverlay.style.display = "none";
      initPlayer(); // í”Œë ˆì´ì–´ ì´ˆê¸°í™” ì‹œì‘
    } else {
      pwErr.textContent = "ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.";
      pwInput.classList.remove("shake");
      void pwInput.offsetWidth; // reflow
      pwInput.classList.add("shake");
      pwInput.value = "";
      pwInput.focus();
      setTimeout(() => pwInput.classList.remove("shake"), 400);
    }
  }

  pwBtn.addEventListener("click", handlePwSubmit);
  pwInput.addEventListener("keydown", e => { if (e.key === "Enter") handlePwSubmit(); });

  // ì´ë¯¸ ì¸ì¦ëœ ê²½ìš° ë°”ë¡œ í†µê³¼
  if (isAuthenticated()) {
    pwOverlay.style.display = "none";
    initPlayer();
  } else {
    setTimeout(() => pwInput.focus(), 100);
  }

  // =========================
  // helpers
  // =========================
  const errEl   = document.getElementById("err");
  const toastEl = document.getElementById("toast");

  function toast(msg, ms=1400) {
    toastEl.textContent = msg;
    toastEl.style.display = "block";
    clearTimeout(toastEl._t);
    toastEl._t = setTimeout(() => toastEl.style.display = "none", ms);
  }

  function getInt(v, d=0) {
    const n = parseInt(v ?? "", 10);
    return Number.isFinite(n) ? n : d;
  }

  function extractIdFromUrl(urlStr) {
    try {
      const u = new URL(urlStr);
      if (u.hostname.includes("youtu.be")) {
        const id = u.pathname.split("/").filter(Boolean)[0];
        return id || null;
      }
      const v = u.searchParams.get("v");
      if (v) return v;
      const shorts = u.pathname.match(/\/shorts\/([a-zA-Z0-9_-]{11})/);
      if (shorts) return shorts[1];
      const embed = u.pathname.match(/\/embed\/([a-zA-Z0-9_-]{11})/);
      if (embed) return embed[1];
      return null;
    } catch { return null; }
  }

  function postToParent(payload) {
    try {
      if (window.parent && window.parent !== window)
        window.parent.postMessage(payload, "*");
    } catch {}
  }

  // =========================
  // í”Œë ˆì´ì–´ ì´ˆê¸°í™” (ì¸ì¦ í›„ í˜¸ì¶œ)
  // =========================
  function initPlayer() {

    // params parse
    const params = new URLSearchParams(location.search);
    let videoId = params.get("v");

    const urlParam = params.get("url");
    if (!videoId && urlParam) videoId = extractIdFromUrl(urlParam);

    if (!videoId) {
      const raw = location.search.startsWith("?") ? location.search.slice(1) : "";
      if (raw.startsWith("http")) videoId = extractIdFromUrl(raw.split("&")[0]);
    }

    const start = Math.max(0, getInt(params.get("start"), 0));
    const end   = Math.max(0, getInt(params.get("end"),   0));
    let rel = params.get("rel") ?? "0";
    if (typeof rel === "string" && rel.includes("^")) rel = rel.split("^")[0];
    rel = (rel === "1") ? "1" : "0";
    const resumeEnabled = (params.get("resume") ?? "1") !== "0";

    if (!videoId || !/^[a-zA-Z0-9_-]{11}$/.test(videoId)) {
      errEl.style.display = "block";
      errEl.innerHTML =
        "ì˜ìƒ IDë¥¼ ì½ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.<br><br>" +
        "âœ… ìƒˆ ì£¼ì†Œ í˜•ì‹(ì¶”ì²œ):<br>" +
        "<b>/youp.html?v=ì˜ìƒID&start=0&end=0&rel=0</b><br><br>" +
        "âœ… ì˜ˆì „ ì£¼ì†Œë„ ì§€ì›ë¨:<br>" +
        "<b>/youp.html?https://youtu.be/ì˜ìƒID</b>";
      return;
    }

    const safeEnd = (end > start) ? end : 0;

    // ì´ì–´ë³´ê¸°
    const STORAGE_KEY    = `YT_RESUME_${videoId}`;
    const RESUME_EXPIRE_MS = 60 * 60 * 1000; // 1ì‹œê°„

    function loadResumeTime() {
      if (!resumeEnabled) return 0;
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return 0;
        const obj = JSON.parse(raw);
        const t = Number(obj?.t ?? 0);
        if (!Number.isFinite(t) || t < 0) return 0;
        const ts = Number(obj?.ts ?? 0);
        if (Date.now() - ts > RESUME_EXPIRE_MS) { clearResumeTime(); return 0; }
        return t;
      } catch { return 0; }
    }

    let lastSavedSec = 0;

    function saveResumeTime(seconds) {
      if (!resumeEnabled) return;
      const t = Math.floor(Number(seconds));
      if (!Number.isFinite(t) || t < 0) return;
      if (t < 2) return;
      if (Math.abs(t - lastSavedSec) < 1) return;
      lastSavedSec = t;
      try { localStorage.setItem(STORAGE_KEY, JSON.stringify({ t, ts: Date.now() })); } catch {}
      postToParent({ type: "GYS_TIME", videoId, time: t });
    }

    function clearResumeTime() {
      try { localStorage.removeItem(STORAGE_KEY); } catch {}
    }

    let resumeTime = loadResumeTime();
    if (safeEnd && resumeTime >= safeEnd - 1) { resumeTime = 0; clearResumeTime(); }

    let initialStart = start;
    if (resumeEnabled && resumeTime > start + 1) initialStart = resumeTime;

    // YouTube IFrame API
    const tag = document.createElement("script");
    tag.src = "https://www.youtube.com/iframe_api";
    document.head.appendChild(tag);

    let player   = null;
    let saveTimer = null;

    window.addEventListener("pagehide",      () => { try { if (player) saveResumeTime(player.getCurrentTime()); } catch {} });
    window.addEventListener("beforeunload",  () => { try { if (player) saveResumeTime(player.getCurrentTime()); } catch {} });

    window.onYouTubeIframeAPIReady = function () {
      player = new YT.Player("playerWrap", {
        width: "100%",
        height: "100%",
        videoId,
        playerVars: {
          autoplay: 1,
          playsinline: 1,
          rel,
          start: Math.floor(initialStart),
          controls: 1,
          disablekb: 0,
          fs: 1,
          modestbranding: 1,
          ...(safeEnd ? { end: Math.floor(safeEnd) } : {}),
        },
        events: { onReady, onStateChange, onError },
      });
    };

    function onReady() {
      saveTimer = setInterval(() => {
        try {
          if (!player) return;
          const state = player.getPlayerState();
          if ([YT.PlayerState.PLAYING, YT.PlayerState.PAUSED, YT.PlayerState.BUFFERING].includes(state))
            saveResumeTime(player.getCurrentTime());
        } catch {}
      }, 1500);
    }

    function onStateChange(e) {
      try {
        if (e.data === YT.PlayerState.ENDED) {
          clearResumeTime();
          postToParent({ type: "GYS_VIDEO_ENDED", videoId });
        }
        if (e.data === YT.PlayerState.PAUSED) saveResumeTime(player.getCurrentTime());
      } catch {}
    }

    function onError(e) {
      postToParent({ type: "GYS_EMBED_ERROR", videoId, code: e?.data ?? "unknown" });
      errEl.style.display = "block";
      errEl.innerHTML =
        "ì´ ì˜ìƒì€ ì„ë² ë“œë¡œ ì¬ìƒì´ ì œí•œë˜ì—ˆê±°ë‚˜ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.<br><br>" +
        "YouTube ì˜¤ë¥˜ ì½”ë“œ: <b>" + (e?.data ?? "unknown") + "</b><br><br>" +
        "ì›ë³¸ í”Œë ˆì´ì–´ë¡œ ìë™ ë³µê·€í•©ë‹ˆë‹¤.";
    }

    // ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ ìœ ì§€
    try {
      const AudioContext = window.AudioContext || window.webkitAudioContext;
      if (AudioContext) {
        const audioCtx = new AudioContext();
        document.addEventListener("click", () => {
          if (audioCtx.state === "suspended") audioCtx.resume();
        }, { once: true });
      }
    } catch {}
  }

})();
</script>
</body>
</html>
